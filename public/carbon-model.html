<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>碳排模型決策系統 - 碳排放儀表板</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/carbon-model.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body class="model-page">
    <div class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="overlay"></div>
    <div class="side-menu">
        <div class="menu-header">
            <div class="menu-title">碳排放系統選單</div>
            <span class="close-btn"><i class="fas fa-times"></i></span>
        </div>
        <div class="user-profile">
            <div class="user-avatar">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="user-info">
                <div class="user-name">王大明</div>
                <div class="user-role">管理員</div>
            </div>
        </div>
        <ul>
            <li><a href="index.html"><i class="fas fa-home"></i>首頁</a></li>
            <li><a href="overview.html"><i class="fas fa-tachometer-alt"></i>整體概覽</a></li>
            <li><a href="factories.html"><i class="fas fa-industry"></i>廠區管理</a></li>
            <li><a href="energy-audit.html"><i class="fas fa-clipboard-check"></i>能源盤查</a></li>
            <li class="carbon-model-item"><a href="carbon-model.html" class="active"><i class="fas fa-brain"></i>碳排模型決策</a></li>
            <li><a href="#"><i class="fas fa-edit"></i>資料編輯</a></li>
            <li><a href="#"><i class="fas fa-sliders-h"></i>手動能源管理</a></li>
            <li><a href="#"><i class="fas fa-bullseye"></i>減碳目標管理</a></li>
            <li><a href="#"><i class="fas fa-chart-line"></i>碳排放報表</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i>系統設定</a></li>
            <li><a href="#"><i class="fas fa-question-circle"></i>幫助中心</a></li>
        </ul>
        <div class="menu-footer">
            <a href="login.html" class="logout-btn"><i class="fas fa-sign-out-alt"></i> 登出</a>
        </div>
    </div>
    
    <header>
        <div class="menu-icon"><i class="fas fa-bars"></i></div>
        <div class="logo"><i class="fas fa-leaf"></i>碳排放儀表板</div>
        <div class="header-actions">
            <div class="user-info">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">3</span>
            </div>
            <div class="user-profile-icon">
                <i class="fas fa-user-circle"></i>
            </div>
        </div>
    </header>
    
    <div class="main-wrapper">
        <div class="container">
            <div class="main-content">
                <div class="model-header">
                    <h1 class="model-title"><i class="fas fa-brain"></i> 碳排模型決策系統</h1>
                    <p class="model-description">透過模型模擬調整參數，最佳化減碳投資與策略決策</p>
                </div>
                
                <div class="nav-tabs mobile-tabs">
                    <div class="nav-tab active">模型設定</div>
                    <div class="nav-tab">成本分析</div>
                    <div class="nav-tab">碳排來源</div>
                    <div class="nav-tab">敏感度</div>
                    <div class="nav-tab">決策地圖</div>
                    <div class="nav-tab">策略比較</div>
                </div>
                
                <div class="tab-content active">
                    <div class="dashboard-grid mobile-grid">
                        <!-- 參數設定卡片 -->
                        <div class="dashboard-card">
                            <h3>參數設定</h3>
                            <div class="parameter-grid mobile-param-grid">
                                <div class="parameter-group">
                                    <div class="parameter-label">
                                        <span>製造階段投資 (Gf)</span>
                                        <span class="parameter-value">$3,000</span>
                                    </div>
                                    <input type="range" id="gf" min="1000" max="5000" value="3000" step="100" oninput="updateParameterValue(this)">
                                </div>
                                
                                <div class="parameter-group">
                                    <div class="parameter-label">
                                        <span>零售階段投資 (Gs)</span>
                                        <span class="parameter-value">$2,500</span>
                                    </div>
                                    <input type="range" id="gs" min="1000" max="5000" value="2500" step="100" oninput="updateParameterValue(this)">
                                </div>
                                
                                <div class="parameter-group">
                                    <div class="parameter-label">
                                        <span>產品定價 (p)</span>
                                        <span class="parameter-value">$85.00</span>
                                    </div>
                                    <input type="range" id="price" min="50" max="120" value="85" step="1" oninput="updateParameterValue(this)">
                                </div>
                                
                                <div class="parameter-group">
                                    <div class="parameter-label">
                                        <span>生產週期 (T)</span>
                                        <span class="parameter-value">45天</span>
                                    </div>
                                    <input type="range" id="cycle" min="20" max="90" value="45" step="1" oninput="updateParameterValue(this)">
                                </div>
                            </div>
                            
                            <div class="parameter-group">
                                <div class="parameter-label">
                                    <span>碳價 (每噸/$)</span>
                                    <span class="parameter-value">$120.00</span>
                                </div>
                                <input type="range" id="carbon-price" min="50" max="300" value="120" step="5" oninput="updateParameterValue(this)">
                            </div>
                            
                            <div class="btn-group mobile-btn-group">
                                <button class="btn btn-primary" onclick="calculateModel()">計算模型</button>
                                <button class="btn btn-outline" onclick="resetModelParameters()">重置預設值</button>
                            </div>
                        </div>
                        
                        <!-- 總成本構成卡片 -->
                        <div class="dashboard-card card-full">
                            <h3>總成本構成</h3>
                            <div class="status-badge status-optimal">接近最佳點</div>
                            <div class="chart-container mobile-chart">
                                <canvas id="costChart"></canvas>
                            </div>
                            <div class="cost-breakdown mobile-cost-grid">
                                <div class="cost-item">
                                    <div class="cost-value">$16,240</div>
                                    <div class="cost-label">總成本</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-value">$5,500</div>
                                    <div class="cost-label">碳減投資</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-value">$7,820</div>
                                    <div class="cost-label">採購成本</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-value">$2,920</div>
                                    <div class="cost-label">碳排成本</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 減碳效率評估卡片 -->
                        <div class="dashboard-card">
                            <h3>減碳效率評估</h3>
                            <div class="chart-container mobile-chart">
                                <canvas id="efficiencyChart"></canvas>
                            </div>
                            <div class="recommendation-card">
                                <div class="recommendation-title">效率評估</div>
                                <p>當前參數設定下，製造階段減碳效率φf = 0.82，零售階段效率φs = 0.65。建議增加製造階段投資以獲得更高的整體效益。</p>
                            </div>
                        </div>
                        
                        <!-- 決策建議卡片 -->
                        <div class="dashboard-card">
                            <h3>決策建議</h3>
                            <div class="recommendation-card">
                                <div class="recommendation-title">成本最小化建議</div>
                                <p>基於當前碳價 ($120/噸)，建議調整參數至：Gf=$3,300，Gs=$2,200，價格=$88，可使總成本下降約 8.2%。</p>
                            </div>
                            <div class="recommendation-card" style="background-color: #e3f2fd; border-left-color: var(--primary);">
                                <div class="recommendation-title" style="color: var(--primary);">碳風險管理建議</div>
                                <p>若碳價上漲至 $180/噸，建議提前增加製造階段投資至 $3,800 並縮短生產週期至 38 天以降低風險。</p>
                            </div>
                        </div>
                        
                        <!-- 策略比較卡片 -->
                        <div class="dashboard-card">
                            <h3>策略比較</h3>
                            <div class="strategy-list mobile-strategy-list">
                                <div class="strategy-item active">當前策略</div>
                                <div class="strategy-item">策略A</div>
                                <div class="strategy-item">策略B</div>
                                <div class="strategy-item">策略C</div>
                                <div class="strategy-item">策略D</div>
                            </div>
                            <div class="chart-container mobile-chart">
                                <canvas id="strategyChart"></canvas>
                            </div>
                            <div class="btn-group mobile-strategy-actions">
                                <button class="btn btn-primary"><i class="fas fa-check-circle"></i> 採用策略</button>
                                <button class="btn btn-outline share-model-btn"><i class="fas fa-share-alt"></i> 分享</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 其他標籤頁內容模板 -->
                <div class="tab-content">
                    <div class="placeholder-message">
                        <i class="fas fa-chart-pie"></i>
                        <p>成本分析模組載入中...</p>
                    </div>
                </div>
                
                <div class="tab-content">
                    <div class="placeholder-message">
                        <i class="fas fa-leaf"></i>
                        <p>碳排來源分析載入中...</p>
                    </div>
                </div>
                
                <div class="tab-content">
                    <div class="placeholder-message">
                        <i class="fas fa-search-dollar"></i>
                        <p>敏感度分析工具載入中...</p>
                    </div>
                </div>
                
                <div class="tab-content">
                    <div class="placeholder-message">
                        <i class="fas fa-map"></i>
                        <p>決策地圖視覺化載入中...</p>
                    </div>
                </div>
                
                <div class="tab-content">
                    <div class="placeholder-message">
                        <i class="fas fa-tasks"></i>
                        <p>策略比較分析載入中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>首頁</span>
        </a>
        <a href="factories.html" class="nav-item">
            <i class="fas fa-industry"></i>
            <span>廠區</span>
        </a>
        <a href="energy-audit.html" class="nav-item">
            <i class="fas fa-clipboard-check"></i>
            <span>能源盤查</span>
        </a>
        <a href="carbon-model.html" class="nav-item active">
            <i class="fas fa-brain"></i>
            <span>決策模型</span>
        </a>
        <a href="settings.html" class="nav-item">
            <i class="fas fa-cog"></i>
            <span>設定</span>
        </a>
    </div>

    <!-- 分享模型結果彈窗 -->
    <div class="model-share-overlay">
        <div class="model-share-popup">
            <div class="popup-header">
                <h3>分享模型結果</h3>
                <span class="close-popup"><i class="fas fa-times"></i></span>
            </div>
            <div class="popup-content">
                <div class="share-option">
                    <label>
                        <input type="checkbox" checked> 包含參數設定
                    </label>
                </div>
                <div class="share-option">
                    <label>
                        <input type="checkbox" checked> 包含成本分析
                    </label>
                </div>
                <div class="share-option">
                    <label>
                        <input type="checkbox" checked> 包含決策建議
                    </label>
                </div>
                <div class="share-option">
                    <label>
                        <input type="checkbox"> 加入註解
                    </label>
                    <textarea placeholder="請輸入註解內容..."></textarea>
                </div>
                <div class="share-method">
                    <h4>分享方式</h4>
                    <div class="method-buttons mobile-method-buttons">
                        <button class="method-btn"><i class="far fa-envelope"></i> 電子郵件</button>
                        <button class="method-btn"><i class="fas fa-file-pdf"></i> PDF報告</button>
                        <button class="method-btn"><i class="fas fa-file-excel"></i> Excel</button>
                        <button class="method-btn"><i class="fas fa-link"></i> 連結</button>
                    </div>
                </div>
            </div>
            <div class="popup-footer">
                <button class="btn btn-outline close-popup-btn">取消</button>
                <button class="btn btn-primary">確認分享</button>
            </div>
        </div>
    </div>
    
    <script src="js/main.js"></script>
    <script>
        // 初始化圖表
        document.addEventListener('DOMContentLoaded', function() {
            initModelTabs();
            initStrategyItems();
            initModelCharts();
            setupShareButtons();
        });
        
        // 更新參數值的函數 - 即時更新
        function updateParameterValue(input) {
            let value = input.value;
            let displayValue = '';
            let prefix = '$';
            let suffix = '';
            
            switch(input.id) {
                case 'gf':
                case 'gs':
                case 'carbon-price':
                    displayValue = prefix + new Intl.NumberFormat().format(value);
                    break;
                case 'price':
                    displayValue = prefix + value;
                    break;
                case 'cycle':
                    prefix = '';
                    suffix = '天';
                    displayValue = prefix + value + suffix;
                    break;
                default:
                    displayValue = value;
            }
            
            // 更新顯示值
            const valueDisplay = input.parentElement.querySelector('.parameter-value');
            if (valueDisplay) {
                valueDisplay.textContent = displayValue;
            }
            
            // 如果需要實時更新圖表
            updateModelChartsLive();
        }
        
        // 初始化標籤頁
        function initModelTabs() {
            const tabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, index) => {
                tab.addEventListener('click', function() {
                    // 移除所有標籤頁的活動狀態
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // 設置當前標籤頁為活動狀態
                    this.classList.add('active');
                    tabContents[index]?.classList.add('active');
                });
            });
        }
        
        // 初始化策略項目
        function initStrategyItems() {
            const strategyItems = document.querySelectorAll('.strategy-item');
            
            strategyItems.forEach(item => {
                item.addEventListener('click', function() {
                    // 移除所有策略項目的活動狀態
                    strategyItems.forEach(i => i.classList.remove('active'));
                    
                    // 設置當前策略項目為活動狀態
                    this.classList.add('active');
                    
                    // 更新策略數據
                    updateStrategyData(this.textContent.trim());
                });
            });
        }
        
        // 計算模型
        function calculateModel() {
            // 顯示載入動畫
            document.querySelector('.loading-overlay').style.display = 'flex';
            
            // 收集參數
            const params = {
                gf: parseInt(document.getElementById('gf').value),
                gs: parseInt(document.getElementById('gs').value),
                price: parseFloat(document.getElementById('price').value),
                cycle: parseInt(document.getElementById('cycle').value),
                carbonPrice: parseInt(document.getElementById('carbon-price').value)
            };
            
            // 模擬計算過程
            setTimeout(() => {
                // 更新圖表和顯示
                updateModelCharts();
                
                // 更新狀態徽章
                updateStatusBadge(params);
                
                // 隱藏載入動畫
                document.querySelector('.loading-overlay').style.display = 'none';
            }, 800);
        }
        
        // 重置模型參數
        function resetModelParameters() {
            // 預設參數
            const defaultParams = {
                gf: 3000,
                gs: 2500,
                price: 85,
                cycle: 45,
                carbonPrice: 120
            };
            
            // 更新滑塊值
            document.getElementById('gf').value = defaultParams.gf;
            document.getElementById('gs').value = defaultParams.gs;
            document.getElementById('price').value = defaultParams.price;
            document.getElementById('cycle').value = defaultParams.cycle;
            document.getElementById('carbon-price').value = defaultParams.carbonPrice;
            
            // 更新顯示值
            document.querySelectorAll('.parameter-group').forEach(group => {
                const slider = group.querySelector('input[type="range"]');
                if (slider) {
                    updateParameterValue(slider);
                }
            });
            
            // 更新圖表
            calculateModel();
        }
        
        // 更新狀態徽章
        function updateStatusBadge(params) {
            const badge = document.querySelector('.status-badge');
            if (!badge) return;
            
            // 根據參數判斷是否接近最優解
            const isNearOptimal = 
                Math.abs(params.gf - 3300) <= 300 && 
                Math.abs(params.gs - 2200) <= 300 && 
                Math.abs(params.price - 88) <= 3;
            
            if (isNearOptimal) {
                badge.textContent = '接近最佳點';
                badge.className = 'status-badge status-optimal';
            } else {
                badge.textContent = '可優化空間';
                badge.className = 'status-badge status-warning';
            }
        }
        
        // 更新策略數據
        function updateStrategyData(strategyName) {
            console.log('更新策略:', strategyName);
            
            // 根據策略名更新圖表
            const strategyChart = window.strategyChart;
            if (!strategyChart) return;
            
            // 模擬不同策略數據
            switch(strategyName) {
                case '策略A':
                    strategyChart.data.datasets[1].data = [16240, 15100, 14800, 15200];
                    break;
                case '策略B':
                    strategyChart.data.datasets[1].data = [16240, 15600, 15200, 14500];
                    break;
                case '策略C':
                    strategyChart.data.datasets[1].data = [16240, 16100, 15500, 14800];
                    break;
                case '策略D':
                    strategyChart.data.datasets[1].data = [16240, 15400, 15000, 15300];
                    break;
                default: // 當前策略
                    strategyChart.data.datasets[1].data = [16240, 15880, 15650, 16100];
            }
            
            strategyChart.update();
        }
        
        // 設置分享按鈕
        function setupShareButtons() {
            // 分享模型按鈕
            const shareBtn = document.querySelector('.share-model-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', function() {
                    document.querySelector('.model-share-overlay').style.display = 'flex';
                });
            }
            
            // 關閉分享彈窗
            const closeButtons = document.querySelectorAll('.close-popup, .close-popup-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelector('.model-share-overlay').style.display = 'none';
                });
            });
        }
        
        // 初始化模型圖表
        function initModelCharts() {
            // 減碳效率評估雷達圖
            const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
            window.efficiencyChart = new Chart(efficiencyCtx, {
                type: 'radar',
                data: {
                    labels: ['製造效率', '運輸效率', '零售效率', '碳排率', '成本效益'],
                    datasets: [{
                        label: '當前策略',
                        data: [0.82, 0.75, 0.65, 0.58, 0.79],
                        backgroundColor: 'rgba(38, 166, 154, 0.2)',
                        borderColor: 'rgba(38, 166, 154, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(38, 166, 154, 1)',
                    }, {
                        label: '最佳策略',
                        data: [0.88, 0.75, 0.70, 0.52, 0.85],
                        backgroundColor: 'rgba(63, 81, 181, 0.2)',
                        borderColor: 'rgba(63, 81, 181, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(63, 81, 181, 1)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                stepSize: 0.2,
                                display: window.innerWidth > 768 // 在手機上隱藏刻度
                            },
                            pointLabels: {
                                font: {
                                    size: window.innerWidth > 768 ? 12 : 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
            
            // 總成本構成圖表
            const costCtx = document.getElementById('costChart').getContext('2d');
            window.costChart = new Chart(costCtx, {
                type: 'bar',
                data: {
                    labels: ['目前成本', '最佳策略', '減碳後'],
                    datasets: [
                        {
                            label: '碳減投資',
                            data: [5500, 5500, 5500],
                            backgroundColor: 'rgba(63, 81, 181, 0.7)',
                        },
                        {
                            label: '採購成本',
                            data: [7820, 7650, 7650],
                            backgroundColor: 'rgba(38, 166, 154, 0.7)',
                        },
                        {
                            label: '碳排成本',
                            data: [2920, 2135, 1854],
                            backgroundColor: 'rgba(255, 152, 0, 0.7)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                font: {
                                    size: window.innerWidth > 768 ? 12 : 10
                                }
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: window.innerWidth > 768,
                                text: '成本 ($)'
                            },
                            ticks: {
                                font: {
                                    size: window.innerWidth > 768 ? 12 : 10
                                }
                            }
                        }
                    },
                    
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 10,
                                padding: 15,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5
        }
    }
                }
            });
            
            // 策略比較圖表
            const strategyCtx = document.getElementById('strategyChart').getContext('2d');
            window.strategyChart = new Chart(strategyCtx, {
                type: 'line',
                data: {
                    labels: ['目前', '短期', '中期', '長期'],
                    datasets: [
                        {
                            label: '當前策略',
                            data: [16240, 16840, 17950, 19200],
                            borderColor: 'rgba(63, 81, 181, 1)',
                            backgroundColor: 'rgba(63, 81, 181, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '最佳策略',
                            data: [16240, 15880, 15650, 16100],
                            borderColor: 'rgba(38, 166, 154, 1)',
                            backgroundColor: 'rgba(38, 166, 154, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: window.innerWidth > 768,
                                text: '總成本 ($)'
                            },
                            ticks: {
                                font: {
                                    size: window.innerWidth > 768 ? 12 : 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: window.innerWidth > 768 ? 12 : 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 更新模型圖表 - 實時更新版本
        function updateModelChartsLive() {
            // 獲取當前參數
            const params = {
                gf: parseInt(document.getElementById('gf').value),
                gs: parseInt(document.getElementById('gs').value),
                price: parseFloat(document.getElementById('price').value),
                cycle: parseInt(document.getElementById('cycle').value),
                carbonPrice: parseInt(document.getElementById('carbon-price').value)
            };
            
            // 實時更新雷達圖
            if (window.efficiencyChart) {
                // 根據參數計算效率
                const mfgEfficiency = Math.min(0.95, 0.5 + (params.gf / 8000));
                const transpEfficiency = Math.min(0.9, 0.65 + (params.cycle > 45 ? -0.1 : 0.1));
                const retailEfficiency = Math.min(0.9, 0.4 + (params.gs / 6000));
                const emissionRate = Math.min(0.95, 0.7 - (params.gf + params.gs) / 20000);
                const costEfficiency = Math.min(0.95, 0.5 + ((params.price * 0.8) / 100));
                
                // 更新數據
                window.efficiencyChart.data.datasets[0].data = [
                    mfgEfficiency.toFixed(2),
                    transpEfficiency.toFixed(2),
                    retailEfficiency.toFixed(2),
                    emissionRate.toFixed(2),
                    costEfficiency.toFixed(2)
                ];
                window.efficiencyChart.update();
            }
            
            // 實時更新成本圖表
            if (window.costChart) {
                // 計算各項成本
                const investment = params.gf + params.gs;
                
                const procurementBase = 7000;
                const procurement = procurementBase + (params.cycle < 45 ? 200 : 0) + (params.price > 85 ? 300 : 0);
                
                const carbonBase = 3500;
                const carbonReduction = (params.gf * 0.0004) + (params.gs * 0.0003);
                const carbon = Math.round(carbonBase * (1 - carbonReduction) * (params.carbonPrice / 100));
                
                const total = investment + procurement + carbon;
                
                // 優化方案成本
                const optimizedProcurement = procurementBase - 100;
                const optimizedCarbon = Math.round(carbon * 0.73);
                const optimizedTotal = investment + optimizedProcurement + optimizedCarbon;
                
                const reducedCarbon = Math.round(carbon * 0.63);
                const reducedTotal = investment + optimizedProcurement + reducedCarbon;
                
                // 更新數據
                window.costChart.data.datasets[0].data = [investment, investment, investment];
                window.costChart.data.datasets[1].data = [procurement, optimizedProcurement, optimizedProcurement];
                window.costChart.data.datasets[2].data = [carbon, optimizedCarbon, reducedCarbon];
                window.costChart.update();
                
                // 更新成本顯示
                document.querySelectorAll('.cost-value')[0].textContent = '$' + new Intl.NumberFormat().format(total);
                document.querySelectorAll('.cost-value')[1].textContent = '$' + new Intl.NumberFormat().format(investment);
                document.querySelectorAll('.cost-value')[2].textContent = '$' + new Intl.NumberFormat().format(procurement);
                document.querySelectorAll('.cost-value')[3].textContent = '$' + new Intl.NumberFormat().format(carbon);
            }
            
            // 實時更新策略圖表
            if (window.strategyChart) {
                // 獲取不同時期的成本變化
                const investment = params.gf + params.gs;
                const procurementBase = 7000;
                const procurement = procurementBase + (params.cycle < 45 ? 200 : 0) + (params.price > 85 ? 300 : 0);
                const carbonBase = 3500;
                const carbonReduction = (params.gf * 0.0004) + (params.gs * 0.0003);
                const carbon = carbonBase * (1 - carbonReduction) * (params.carbonPrice / 100);
                const total = investment + procurement + carbon;
                
                // 計算當前策略未來變化
                const shortTerm = total * (1 + 0.037);
                const midTerm = total * (1 + 0.105);
                const longTerm = total * (1 + 0.182);
                
                // 更新數據
                window.strategyChart.data.datasets[0].data = [total, shortTerm, midTerm, longTerm];
                window.strategyChart.update();
            }
            
            // 更新決策建議
            updateRecommendations(params);
            
            // 根據參數更新狀態徽章
            updateStatusBadge(params);
        }
        
        // 更新決策建議
        function updateRecommendations(params) {
            // 計算推薦參數
            const recGf = Math.min(5000, params.gf + (params.gf < 3300 ? 300 : -100));
            const recGs = Math.min(5000, params.gs + (params.gs < 2200 ? 0 : -300));
            const recPrice = params.price < 88 ? 88 : params.price;
            
            // 計算成本節省比例
            const investment = params.gf + params.gs;
            const procurement = 7000 + (params.cycle < 45 ? 200 : 0) + (params.price > 85 ? 300 : 0);
            const carbon = 3500 * (1 - ((params.gf * 0.0004) + (params.gs * 0.0003))) * (params.carbonPrice / 100);
            const total = investment + procurement + carbon;
            
            const recInvestment = recGf + recGs;
            const recProcurement = 7000 - 100; // 優化後採購成本
            const recCarbon = 3500 * (1 - ((recGf * 0.0004) + (recGs * 0.0003))) * (params.carbonPrice / 100) * 0.73;
            const recTotal = recInvestment + recProcurement + recCarbon;
            
            const savings = ((total - recTotal) / total * 100).toFixed(1);
            
            // 更新建議文字
            const recommendations = document.querySelectorAll('.recommendation-card');
            if (recommendations.length >= 1) {
                const p = recommendations[0].querySelector('p');
                if (p) {
                    p.innerHTML = `基於當前碳價 ($${params.carbonPrice}/噸)，建議調整參數至：Gf=$${recGf}，Gs=$${recGs}，價格=$${recPrice}，可使總成本下降約 ${savings}%。`;
                }
            }
            
            if (recommendations.length >= 2) {
                const p = recommendations[1].querySelector('p');
                if (p) {
                    const highCarbon = Math.round(params.carbonPrice * 1.5);
                    const emergGf = Math.min(5000, recGf + 500);
                    const emergCycle = Math.max(20, params.cycle - 7);
                    p.innerHTML = `若碳價上漲至 $${highCarbon}/噸，建議提前增加製造階段投資至 $${emergGf} 並縮短生產週期至 ${emergCycle} 天以降低風險。`;
                }
            }
        }
        
        // 處理窗口大小變化
        window.addEventListener('resize', function() {
            if (window.efficiencyChart) {
                window.efficiencyChart.options.scales.r.ticks.display = window.innerWidth > 768;
                window.efficiencyChart.options.scales.r.pointLabels.font.size = window.innerWidth > 768 ? 12 : 10;
                window.efficiencyChart.update();
            }
            
            if (window.costChart) {
                window.costChart.options.scales.y.title.display = window.innerWidth > 768;
                window.costChart.options.scales.y.ticks.font.size = window.innerWidth > 768 ? 12 : 10;
                window.costChart.options.scales.x.ticks.font.size = window.innerWidth > 768 ? 12 : 10;
                window.costChart.update();
            }
            
            if (window.strategyChart) {
                window.strategyChart.options.scales.y.title.display = window.innerWidth > 768;
                window.strategyChart.options.scales.y.ticks.font.size = window.innerWidth > 768 ? 12 : 10;
                window.strategyChart.options.scales.x.ticks.font.size = window.innerWidth > 768 ? 12 : 10;
                window.strategyChart.update();
            }
        });
    </script>
</body>
</html>